generator client {
  provider = "prisma-kysely"
  output   = "../src/db"
  fileName = "types.ts"
}

datasource db {
  provider = "mysql"
  url      = env("DB_URL")
}

model accounts {
  id         Int       @id @default(autoincrement())
  created_at DateTime  @default(now()) @db.Timestamp(3)
  updated_at DateTime  @default(now()) @db.Timestamp(3)
  deleted_at DateTime?
  email      String    @unique
  username   String?   @unique
  password   String

  // Password Reset Fields
  reset_code          String?   @db.VarChar(6)
  reset_code_expires  DateTime? @db.Timestamp(3)
  reset_attempts      Int       @default(0)
  reset_blocked_until DateTime? @db.Timestamp(3)

  // Relations
  sessions     sessions[]
  user         users?
  account_role account_role[]

  // Indexes
  @@index([created_at])
  @@index([updated_at])
  @@index([deleted_at])
  @@index([email])
}

model users {
  id         Int       @id @default(autoincrement())
  created_at DateTime  @default(now()) @db.Timestamp(3)
  updated_at DateTime  @default(now()) @db.Timestamp(3)
  deleted_at DateTime?
  first_name String?
  last_name  String?

  // Foreign Keys
  account_id Int? @unique

  // Relations
  account accounts? @relation(fields: [account_id], references: [id], onDelete: Cascade)

  // Indexes
  @@index([created_at])
  @@index([updated_at])
  @@index([deleted_at])
  @@index([first_name])
  @@index([last_name])
}

model sessions {
  id            Int       @id @default(autoincrement())
  created_at    DateTime  @default(now()) @db.Timestamp(3)
  updated_at    DateTime  @default(now()) @db.Timestamp(3)
  deleted_at    DateTime?
  refresh_token String    @unique @db.VarChar(512)

  // Foreign Keys
  account_id Int?

  // Relations
  account accounts? @relation(fields: [account_id], references: [id])

  // Indexes
  @@index([created_at])
  @@index([updated_at])
  @@index([deleted_at])
  @@index([account_id])
}

model roles {
  id         Int       @id @default(autoincrement())
  name       String    @unique
  created_at DateTime  @default(now()) @db.Timestamp(3)
  updated_at DateTime  @default(now()) @db.Timestamp(3)
  deleted_at DateTime?

  // Relations
  permission_role permission_role[]
  account_role    account_role[]

  // Indexes
  @@index([created_at])
  @@index([updated_at])
  @@index([deleted_at])
}

model account_role {
  // Foreign Keys
  account_id Int
  role_id    Int

  // Relations
  account accounts @relation(fields: [account_id], references: [id], onDelete: Cascade)
  role    roles    @relation(fields: [role_id], references: [id], onDelete: Cascade)

  @@id([account_id, role_id])
  @@index([role_id, account_id])
}

model permissions {
  id         Int       @id @default(autoincrement())
  name       String    @unique
  created_at DateTime  @default(now()) @db.Timestamp(3)
  updated_at DateTime  @default(now()) @db.Timestamp(3)
  deleted_at DateTime?

  // Relations
  permission_role permission_role[]

  // Indexes
  @@index([created_at])
  @@index([updated_at])
  @@index([deleted_at])
}

model permission_role {
  // Foreign Keys
  role_id       Int
  permission_id Int

  // Relations
  role       roles       @relation(fields: [role_id], references: [id], onDelete: Cascade)
  permission permissions @relation(fields: [permission_id], references: [id], onDelete: Cascade)

  @@id([role_id, permission_id])
  @@index([role_id, permission_id])
}
